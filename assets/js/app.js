function sysMsg(a){$sys.attr("data-system-message",a)}function DashboardLogic(){var a,b,c=this;this.optimizeData=function(){return $(b).each(function(a,c){b[a].awd=parseInt(c.awd),b[a].high=parseInt(c.high),b[a].convertible=parseInt(c.convertible),b[a].price=parseInt(c.price),b[a].cost=parseInt(c.cost),b[a].speed=parseInt(c.speed),b[a].mph=parseInt(c.mph),b[a].economy=parseInt(c.economy),b[a].mpg=parseFloat(c.mpg)}),b},this.eggs=function(a){var b=["Alien","Dog","Cat"],c=a.seats[4],d=[],e=$.inArray(c,b);return e>=0&&d.push(b[e].toLowerCase()),5===a.speed&&d.push("rocket"),d.length<=0&&(d=!1),d},this.getCars=function(b){if("object"==typeof b.eggs)return{data:"easter egg"};var c=a().get();dataLogic.query=b.raw,dataLogic.carCollectionController(c)},this.publishCar=function(a){ui.render(a)},this.getCarByName=function(b){return a({name:b}).first()},this.getCarByCode=function(b){return a({code:b}).first()},this.query=function(){this.filter=function(a,b){var b=b||[];a.capacity||delete a.capacity,a.luggage||delete a.luggage,a.lifestyle||delete a.lifestyle,a.awd||delete a.awd,a.high||delete a.high,a.convertible||delete a.convertible,a.price||delete a.price,a.speed||delete a.speed,a.economy||delete a.economy;for(var c=0;c<b.length;c++)delete a[b[c]];return a},this.build=function(a,b){var c,d={},e=a,f=[];return e.capacity&&(d.capacity={likenocase:e.capacity}),e.luggage?d.luggage={likenocase:e.luggage}:a.luggage=0,e.lifestyle?d.lifestyle={likenocase:e.lifestyle}:a.lifestyle=0,e.awd&&(d.awd=e.awd,f.push("1"),a.awd=1),e.high&&(d.high=e.high,f.push("3"),a.high=1),e.convertible&&(d.convertible=e.convertible,f.push("2"),a.convertible=1),e.price?d.price={lt:e.price+1}:a.price=0,e.speed?d.speed={gt:e.speed-1}:a.speed=0,e.economy?d.economy={gt:e.economy-1}:a.economy=0,f.length>0?a.options=f:a.options=0,c={prepared:d,raw:a}},this.convert=function(a){function b(a){return 25>a?0:a>=25&&46>a?1:a>=46&&61>a?2:a>=61&&70>a?3:a>=70?4:void 0}function c(a){return 190>a?0:a>=191&&215>a?1:a>=216&&245>a?2:a>=246&&269>a?3:a>=270&&294>a?4:a>=295?5:void 0}function d(a){return"minimalist"===a?1:"light-packer"===a?2:"lugger"===a?3:"big-loader"===a?4:void 0}function e(a){var b={people:0,children:0,infants:0};if(a=_.compact(a),a.length<1)return 0;for(var c=0;c<a.length;c++){var d=a[c];("Man"===d||"Woman"===d)&&b.people++,("Girl"===d||"Boy"===d)&&b.children++,"Infant"===d&&b.infants++}return b.family=b.people+b.children,b.family<=2&&0===b.infants?1:2===b.people&&0<b.children&&b.children<=2&&0===b.infants?3:1===b.people&&0<b.children&&b.children<=3&&0===b.infants?3:b.family<=4&&0===b.infants?2:b.family<=3&&1===b.infants?2:5===b.family?4:4===b.family&&1===b.infants?4:3===b.family&&2===b.infants?4:1}return obj={capacity:_.compact(a.seats).length>0?e(a.seats).toString():!1,luggage:d(a.luggage).toString(),lifestyle:parseInt(a.lifestyle).toString(),price:c(a.price),speed:"lightspeed"===a.speed?a.speed:parseInt(a.speed),economy:b(a.mpg),awd:a.options.awd||!1,high:a.options.hp||!1,convertible:a.options.dt||!1},obj}};var d=function(d){return b=d,a=TAFFY(JSON.stringify(b)),c.database=a,$.publish("data-loaded"),a},e=function(){var a=store.get("miniData")||!1;a?d(a):$.ajax({url:path.api,error:function(){alert("There's been a problem obtaining the results.")},success:function(a){a.Error?alert(a.Error):(d(a),store.set("miniData",a))}})};e()}function DataLogic(){function a(){var a=[];return{size:function(){return a.length},add:function(b){a.push(b)},all:function(){return a},latest:function(){return a.slice(-1).pop()}}}var b=this;this.query=null,this.oldQuery=null,this.activeCar=null,this.repeatSearch=null,this.selection=["capacity","luggage","convertible","high","awd","price","speed","economy","lifestyle"],this.carCollectionController=function(a){function c(a,c){h.store=[],h.reduced=0;for(var d=0;d<a.length;d++){var e=a[d];h.matchDatasetValueAgainstQueryValue(e[c],b.query[c],e),d===a.length-1&&h.endMasterLoop(a,c)}}var d=a,e={minNoResults:2},f={count:0,update:function(){this.count++},echo:function(){return this.count}},g={shuffle:function(a){for(var b,c,d=a.length;d;)c=Math.floor(Math.random()*d--),b=a[d],a[d]=a[c],a[c]=b;return a},convertValueToArray:function(a){return"number"==typeof a&&(a=a.toString()),"string"==typeof a&&a.length>1&&(a=a.split("")),a},matchSingleValueInArrary:function(a,b){return-1!=a.indexOf(b)},matchArrayValuesInArrary:function(a,b){var c=b.length,d=0;if("object"!=typeof b)return!1;for(var e=0;c>e;e++){if(!g.matchSingleValueInArrary(a,b[e]))return!1;if(d++,c===d)return!0}},areValuesValid:function(a,b){return g.isValueLegitimate(a)&&g.isValueLegitimate(b)},doValuesMatch:function(a,b){return g.matchArrayValuesInArrary(a,b)||g.matchSingleValueInArrary(a,b)},isValueLegitimate:function(a){return"n/a"!==a&&"TBC"!==a&&"undefined"!=typeof a&&null!==a&&0!=a},shallWeContinueTheLoop:function(a,b){return!!(a.length>e.minNoResults&&"undefined"!=typeof b)}},h={store:[],reduced:0,outputDatasetMessages:function(a,b){0!==this.reduced},matchDatasetValueAgainstQueryValue:function(a,b,c){var d=g.convertValueToArray(a),e=function(){return h.addObjectToCollection(c),!0},f=function(){};return void 0===b?e():(b=b.toString(),!!g.areValuesValid(a,b)&&(g.doValuesMatch(d,b)?e():f()))},matchSingleRecord:function(a){var b=this;for(var c in a)if(g.isValueLegitimate(a[c])&&a[c]==b[c])return!0},addObjectToCollection:function(a){h.store.push(a),h.reduced++},haveWeReachedTheEnd:function(a,d){var e=function(){f.update(),c(a,d[f.echo()])},h=function(){b._collection.add(a);var c=Array.prototype.slice.call(b._collection.latest());b.activeCar=c[0],dashboardLogic.publishCar(c[0])};return g.shallWeContinueTheLoop(a,d[f.echo()+1])?e():h()},endMasterLoop:function(a,c){h.outputDatasetMessages(c,a),0===this.reduced&&(h.store=a),h.haveWeReachedTheEnd(h.store,b.selection)}};c(d,b.selection[f.echo()])},this.sendCarToRender=function(){},this.cycleThroughCarList=function(){var a=Array.prototype.slice.call(b._collection.latest()),c=a.indexOf(b.activeCar);++c<=a.length-1?(b.activeCar=a[c],dashboardLogic.publishCar(a[c])):(b.activeCar=a[0],dashboardLogic.publishCar(a[0]))},this.init=function(){this._collection=a(),$.subscribe("data-ready",function(a){})}}function FormLogic(){var a=this;this.colors=function(a){$(".switch-bg").css({"background-color":a})},this.getAddresses=function(a){return $.when($.ajax({url:path.apiPostcode,data:{postcode:a},error:function(a){tpl=!1}})).then(function(a,b,c){return 200===c.status?a:void 0})},this.getDealers=function(a){return $.when($.ajax({url:path.apiDealers,data:{postcode:a},error:function(a){tpl=!1}})).then(function(a){return a})},this.getFinance=function(b){var c=dashboardLogic.getCarByCode(b),d=c.finance;return d.name=c.name,d.payment=a.numberWithCommas(Number(d.payment).toFixed(2)),d.price=a.numberWithCommas(Number(d.price).toFixed(2)),d.deposit=a.numberWithCommas(Number(d.deposit).toFixed(2)),d.contribution=a.numberWithCommas(Number(d.contribution).toFixed(2)),d.purchase_fee=a.numberWithCommas(Number(d.purchase_fee).toFixed(2)),d.final_payment=a.numberWithCommas(Number(d.final_payment).toFixed(2)),d.total_deposit=a.numberWithCommas(Number(d.total_deposit).toFixed(2)),d.total_amount=a.numberWithCommas(Number(d.total_amount).toFixed(2)),d.credit_charge=a.numberWithCommas(Number(d.credit_charge).toFixed(2)),d.terms=c.terms,d},this.numberWithCommas=function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.formatAddress=function(a,b){for(var b=b||[],c=new String,d=0;d<b.length;d++){var e=b[d];delete a[e]}for(var e in a)_.isEmpty(a[e])||(c+=a[e]+", ");return c=c.substr(0,c.length-2)},this.formatDealerAddresses=function(a){var b=new String;for(var c in a)if(!_.isEmpty(a[c]))if("Name"===c)b+=a[c]+", ";else if("Address"===c){var d=a[c].split(";");b+=d.slice(Math.max(d.length-2,1)).join(", ")+", "}return b=b.substr(0,b.length-2)},this.handlePostcode=function(b){var c=$("#postcode_search").val();formLogic.getAddresses(c).then(function(a){null!==a&&($(".disabled").removeClass("disabled").find("[disabled]").prop("disabled",!1),addressObj=a,formattedAddresses=[],$(form.addressChooser).contents().remove(),$(a).each(function(a,b){var c=new String;for(var d in b)_.isEmpty(b[d])||(c+=b[d]+", ");c=c.substr(0,c.length-2),formattedAddresses.push({id:a,address:c})}),ui.getTpl("addresses").then(function(a){$(form.addressChooser).append(ui.renderTpl(a,{addresses:formattedAddresses})),$(form.addresses).rules("add",{required:!0,messages:{required:"Please select your address from the list."}}),$(".loader-inline").removeClass("active")}))}),formLogic.getDealers(c).then(function(b){dealersObj=b,formattedDealers=[],$(form.dealerChooser).contents().remove(),$(b).each(function(b,c){var d=a.formatDealerAddresses(c),e=c.DealerId;formattedDealers.push({id:e,dealer:d})}),ui.getTpl("dealers").then(function(a){$(form.dealerChooser).append(ui.renderTpl(a,{dealers:formattedDealers})),$(form.dealers).rules("add",{required:!0,messages:{required:"Please select your nearest dealer."}})})})},this.addressStuff=function(a){var b=$(a.target),c=addressObj[b.val()];if(_.isEmpty(b.val()))$(form.address1).val(null),$(form.address2).val(null),$(form.address3).val(null),$(form.town).val(null),$(form.postcode).val(null);else{var d=$("#postcode_search").val();$(form.address1).val(c.Address1),$(form.address2).val(c.Address2),$(form.address3).val(c.Address3),$(form.town).val(c.Town),$(form.postcode).val(d)}},this.postcodeStuff=function(a){a.preventDefault(),$("#postcode_search").validate(),$("#postcode_search").valid()&&($(a.target).next(".loader-inline").addClass("active"),postcodeTimer=setTimeout(this.handlePostcode,600))},this.phoneNumber=function(a){var b=$(a.target).val();b=b.replace(/[\s().-]+/g,""),$(a.target).val(b)},this.ajaxFormResults=function(){var a=$(".thanks-content"),b=$(".form-content");a.hide(),$.subscribe("form-ajax-results",function(c,d){b.slideUp(600),a.slideDown(600)})},this.activateForms=function(){dashboard.activateDashColor(),$("form").validate(),$.subscribe("form-ajax-results",function(a,b){b.success?ui.showPanel("thanks"):ui.showPanel("error")})},this.eventListeners=function(){$body.on("change",form.addresses,function(b){a.addressStuff(b)}),$body.on("click",form.addressLookup,function(b){a.postcodeStuff(b)}),$("input").bind("keydown",function(a){13===a.which&&(a.stopPropagation(),a.preventDefault(),$(this).nextAll("input").eq(0).focus())}),$("#tel_home").on("blur",function(b){a.phoneNumber(b)})},this.validateStoredInput=function(){void 0===store.get("miniInput")&&-1!=window.location.href.indexOf("/form")&&(window.location.href=window.location.href.replace("/form",""))},this.enableUserTracking=function(){$("#results_recombobulate a,#results_back a").attr("href","/"+window.location.search)},this.init=function(){a.validateStoredInput(),a.enableUserTracking(),a.eventListeners(),a.ajaxFormResults(),a.activateForms()}}function Dials(){this.roller=function(a){var b=$(a).siblings(".list"),c=b.find(".item:nth-child( 2 )").height(),d=c*(b.find(".item").length-1),e=function(){var a=this;TweenLite.to(a.$slot.get(0),.6,{y:0,onComplete:function(){a.update()}}),a.$list.find(".item").removeClass("active"),a.$list.removeClass("dragging").removeAttr("style"),a.update()},f=function(){var a=g(this.y,c,0),d=b.find(".item").eq(a),e=d.data("value")||d.text();return"Empty"===e?0:e},g=function(a,b,c){var d=a-b/2,e=Math.ceil(d/b);return Math.abs(e)+1};$(a).height(d);var h=new Draggable(a,{type:"y",bounds:$(a).parent(),edgeResistance:1,throwProps:!0,onDrag:function(){var a=g(this.y+40,c,0);b.find(".item").removeClass("active").eq(a).addClass("active");b.addClass("dragging").css({transform:"translate3d( 0px, "+this.y+"px, 0px )"})},onDragEnd:function(){b.removeClass("dragging").css({transform:"translate3d( 0px, "+this.endY+"px, 0px )"});var c=$(a).closest(".control-wrapper").attr("id");trackDialEvents(c)},snap:function(a){return Math.round(a/c)*c}});return h.getValue=f,h.reset=e,h.$list=b,h.$slot=$(a),h},this.luggage=function(){var a=0,b=document.querySelector(".control.luggage .dial"),c=90,d=function(){return $(b).attr("class").replace("dial","").trim()},e=function(d){$(b).removeClassExcept("dial");var e=($(".control.luggage .dial"),"left"===d?a+c:a-c);TweenLite.to(b,1,{rotation:e,onComplete:function(a){i(e);var c=$(b).closest(".control-wrapper").attr("id");trackDialEvents(c)}}),j.update(),a=e},f=function(a,b){a.removeClass("right left"),e(b)},g=function(a,b){a.removeClass("right left").addClass(b)},h=function(){$("#left, #right").on("mousedown mouseup touchstart touchend",function(a){a.stopPropagation(),a.preventDefault();var b=$(this).parent(),c=a.target.id;"mousedown"===a.type||"touchstart"===a.type?g(b,c):f(b,c)})},i=function(a){var d=a/c%c%4;(-1===d||3===d)&&(final_class="light-packer"),(-2===d||2===d)&&(final_class="lugger"),(-3===d||1===d)&&(final_class="big-loader"),0===d&&(final_class="minimalist"),$(b).removeClassExcept("dial").addClass(final_class)},j=new Draggable(b,{type:"rotation",throwProps:!0,onThrowComplete:function(){i(parseInt(this.endRotation))},onDragStart:function(a){$(b).removeClassExcept("dial")},onDragEnd:function(b){a=parseInt(this.endRotation)},snap:function(a){return Math.round(a/c)*c}});return h(),j.getLuggage=d,j},this.options=function(){this.getOptions=function(){var a=$(".control.options input"),b={};return a.each(function(a,c){b[$(this).attr("id")]=$(this).hasClass("checked")}),b},$(".option").on("click",function(a){a.preventDefault();var b=$(this).find("input");b.toggleClass("checked");var c=$(a.target).closest(".control-wrapper").attr("id");trackDialEvents(c)})},this.lifestyle=function(){function a(a){ie.loadFallbacks()?"right"===a?ie.lifestyle.prev():ie.lifestyle.next():"right"===a?f.slick("slickPrev"):f.slick("slickNext");var b=$(f).closest(".control-wrapper").attr("id");trackDialEvents(b)}var b,c=function(){return $("#c-lifestyle .slick-slide.slick-active").attr("data-value")},d=document.querySelector(".control.lifestyle .dial"),e=5,e=45;if(!ie.loadFallbacks())var f=$(".items-wrapper").slick({arrows:!1,infinite:!0,slide:".item",onAfterChange:function(){g.enable()}});var g=new Draggable(d,{type:"rotation",bounds:{minRotation:-e,maxRotation:e},throwProps:!0,snap:function(a){return!0},onDragStart:function(){b=Math.abs(this.y)},onDragEnd:function(){var c=Math.abs(this.y)>b?"right":"left";a(c)}});return $(".control.lifestyle").off("click").on("click",function(b){var c,d=$(this).width(),e=$(this).offset().left,f=b.pageX-e,g=d/2;c=g>f?"left":"right",a(c)}),g.getLifestyle=c,g},this.mpg=function(){var a=document.querySelector(".control.mpg .arrow"),b=120,c=13,d=25,e=80,f=function(){return g._value},g=new Draggable(a,{type:"rotation",bounds:{minRotation:-b,maxRotation:b},onDrag:function(){var f=(this.rotation+b)/(2*b),g=parseInt((f+1/(2*c))*c),h=e-d,i=parseInt(d+f*h);this._value=i,$(".control.mpg").addClass("scale-"+g).removeClassExcept("control mpg scale-"+g),$("#mpg_value").text(i);var j=$(a).closest(".control-wrapper").attr("id");trackDialEvents(j)}});return TweenLite.set(a,{rotation:-b}),g.update(),g._value=d,$("#mpg_value").text(g._value),g.getMpg=f,g},this.price=function(){var a=function(){var a=b(d)||0,c=190,e=300,f=e-c;return parseInt(f/100*a)+c},b=function(a){var b=Math.abs(parseInt(a.endY)),c=Math.abs(b/a.minY*100);return c},c=function(a){var b=Math.abs(parseInt(a.endY)),c=b+13+"px";return c},d=new Draggable(".control.price .handle",{type:"y",edgeResistance:1,bounds:".control.price .bounds",throwProps:!1,onDragStart:function(){priceChanged=!0},onDrag:function(){$(".control.price .switch-bg").css("height",c(this));var a=$(".control.price").closest(".control-wrapper").attr("id");trackDialEvents(a)}});return d.getPrice=a,d}}function Dashboard(){var a,b,c,d,e,f,g,h=this;this.colors=function(a){$(".switch-bg").css({"background-color":a}),$(".related .active").css({"border-color":a}),$(".switch-fill path").css({fill:a}),$(".switch-light").css({"-webkit-box-shadow":"0 0 5px "+a+", 0 0 15px "+a,"-moz-box-shadow":"0 0 5px "+a+", 0 0 15px "+a,"-box-shadow":"0 0 5px "+a+", 0 0 15px "+a,"background-color":a}),$(".switch-color").css({color:a})},this.seats=function(){var b=new a.roller("#c-bums #roller1 .fake-list"),c=new a.roller("#c-bums #roller2 .fake-list"),d=new a.roller("#c-bums #roller3 .fake-list"),e=new a.roller("#c-bums #roller4 .fake-list"),f=new a.roller("#c-bums #roller5 .fake-list"),g=function(){var a=[];return a.push(b.getValue()),a.push(c.getValue()),a.push(d.getValue()),a.push(e.getValue()),a.push(f.getValue()),a};return $("#reset").on("click",function(a){var g=$(a.target).closest(".control-wrapper").attr("id");trackDialEvents(g),a.preventDefault(),b.reset(),c.reset(),d.reset(),e.reset(),f.reset()}),g()},this.values=function(){var a=ie.loadFallbacks()?ie.rollers.getSeats():h.seats(),i=ie.loadFallbacks()?ie.rollers.getSpeed():g.getValue(),j=ie.loadFallbacks()?ie.lifestyle.get():f.getLifestyle(),k={seats:a,lifestyle:j,speed:i,mpg:c.getMpg(),luggage:d.getLuggage(),options:e.getOptions(),price:b.getPrice()};return k},this.activateDashColor=function(){var a=carCode?dashboardLogic.getCarByCode(carCode).color:!1,b=a?a:"Blazing Red";dashboard.colors(carColors[b]),$.subscribe("colour-change",function(a,b){dashboard.colors(b),formLogic.colors(b)})},this.activateDashboard=function(){a=new Dials,b=new a.price,c=new a.mpg,d=new a.luggage,e=new a.options,f=new a.lifestyle,ie.loadFallbacks()?(ie.rollers.init(),ie.speed.init(),ie.lifestyle.init(),runWhenElementExsists("#bums #rollers .item svg",dashboard.activateDashColor)):(g=new a.roller("#c-speed .control.speed .fake-list"),h.seats())},this.init=function(){$("#dash").length&&(h.activateDashColor(),h.activateDashboard())}}function Combobulate(){var a=this;this.animateCombobulate=function(a){function b(){return $("html, body").animate({scrollTop:0},600),!1}a.preventDefault();var c=$(a.target).parent();c.css("pointer-events","none"),TweenMax.from($("#start .button-inner"),.5,{rotation:-360,onComplete:function(){b(),c.css("pointer-events","auto"),setTimeout(function(){$("#tablet-toggle").click(),$(".layout-dash > .column.left").removeClass("open")},600)}})},this.executeSearch=function(){function a(){var a=$(".button-inner .switch-bg").css("background-color");$.publish("colour-change",a)}var b=dashboard.values();store.set("miniInput",b),$html.removeClassBeginningWith("egg");var c=dashboardLogic.eggs(b);if($.inArray("toy",c)>=0||$.inArray("rocket",c)>=0)return void($.inArray("rocket",c)>=0&&$.inArray("toy",c)>=0?ui.eggs("rocket",c):$.inArray("toy",c)>=0?ui.eggs("toy",c):ui.eggs("rocket",c));var d=query.build(query.convert(dashboard.values()));if(_.isEqual(dataLogic.oldQuery,d))dataLogic.cycleThroughCarList();else{dashboardLogic.getCars(d);dataLogic.oldQuery=d}runWhenElementExsists($("#tpl-results .model-name"),a)},this.showAlternateCars=function(a){a.preventDefault();var b=$(a.target).parent(),c=b.attr("href"),d=dashboardLogic.getCarByCode(c.substring(1));$(".car-changer").removeClass("active").filter(b).addClass("active"),ui.render(d,!0)},this.eventListeners=function(){$body.on("click",".car-changer",function(b){a.showAlternateCars(b),_gaq.push(["_trackEvent","Dashboard","Related cars"])}),$("#start").on("click",function(b){a.animateCombobulate(b),a.executeSearch(),_gaq.push(["_trackEvent","Dashboard","Combobulate button"])}),$.subscribe("sort-finished",function(a,b){ui.render(b)})},this.init=function(){a.eventListeners()}}function Finance(){var a=this;this.renderFinanceTpl=function(){if($("#page-results").length>0){var a=formLogic.getFinance(carCode);ui.getTpl("finance").then(function(b){function c(){0===parseInt(a.contribution)&&($(".retailer-deposit-contribution--row").addClass("hide"),$(".customer-deposit--row").addClass("hide")),$(".terms-toggle .hide-terms").addClass("hide"),$(".terms").slideUp(1,function(){$("#finance-template").addClass("fadeIn")}),$(".terms-toggle").on("click",function(){$(".terms-toggle").hasClass("open")?($(".terms").slideUp(),$(".terms-toggle").removeClass("open"),$(".terms-toggle .hide-terms").addClass("hide"),$(".terms-toggle .show-terms").removeClass("hide")):($(".terms").slideDown(),$(".terms-toggle").addClass("open"),$(".terms-toggle .show-terms").addClass("hide"),$(".terms-toggle .hide-terms").removeClass("hide"))})}$("#tpl-finance").replaceWith(ui.renderTpl(b,a)),runWhenElementExsists($("#finance-template"),c)})}},this.init=function(){a.renderFinanceTpl()}}function UI(){var a=this;this.$panel=$body.find(".panel-results"),this.getTpl=function(a){var b=new $.Deferred,c=store.get("miniTemplates")||{};return c.hasOwnProperty(a)?b.resolve(c[a]):b=$.get(path.templates+"/"+a+".mustache").then(function(b){var c=store.get("miniTemplates")||{},d={};return d[a]=b,c.hasOwnProperty(a)||store.set("miniTemplates",_.extend(c,d)),b}),b},this.renderTpl=function(a,b){return Mustache.render(a,b)};var b=function(a,b){var c=$body.find("#uid").val();return"undefined"==typeof c?a+"m="+b:a+"m="+b+"&c="+c};this.loadSVGs=function(){var a=document.querySelectorAll(".svg");SVGInjector(a,{pngFallback:path.spriteFallback,each:function(a){$(a).hide().fadeIn(600)}})},this.showPanel=function(a){$body.find("[data-panel-name]").removeClass("panel-active"),$body.find('[data-panel-name="'+a+'"]').addClass("panel-active")},this.currentScale=0,this.fudgeMpg=function(){$(".control.mpg").prop("class","control mpg scale-"+a.currentScale),14==a.currentScale&&($(".control.mpg").prop("class","control mpg scale-0"),$sys.toggleClass("hidden"),setTimeout(function(){introAnimations.init()},2e3)),++a.currentScale,setTimeout(a.fudgeMpg,1e3)},this.preloadImages=function(){this.loadSVGs(),$(window).load(function(){$sys.toggleClass("hidden"),setTimeout(function(){introAnimations.init()},500)})},this.render=function(a,c){var d=this,c=c||!1,e=function(a,b){var c=d.$panel.find(".car-changer"),b=b||!1,e=dashboardLogic.getCarByCode(a.alt_1),f=dashboardLogic.getCarByCode(a.alt_2),g=dashboardLogic.getCarByCode(a.alt_3);if(e===!1||f===!1||g===!1){alert("missing alternate car - check console.log for missing value");_.isObject(e)?"":" - NO MATCH FOUND IN "+path.api,_.isObject(f)?"":" - NO MATCH FOUND IN "+path.api,_.isObject(g)?"":" - NO MATCH FOUND IN "+path.api}else b||(c.removeClass("active").filter(":first").addClass("active"),c.eq(0).attr("href","#"+a.code).find("img").attr("src",path.assets+"thumbnails/"+a.code+".jpg"),c.eq(1).attr("href","#"+e.code).find("img").attr("src",path.assets+"thumbnails/"+e.code+".jpg"),c.eq(2).attr("href","#"+f.code).find("img").attr("src",path.assets+"thumbnails/"+f.code+".jpg"),c.eq(3).attr("href","#"+g.code).find("img").attr("src",path.assets+"thumbnails/"+g.code+".jpg"))};Mini.browser.mobile&&setTimeout(function(){$("#layout-dash > .column.left").removeClass("open")},0),a.url=b(path.results,a.code),a.img=path.assets+a.code+".jpg","RKT"===a.code?this.getTpl("rocketcar").then(function(b){$("#tpl-results").contents().remove(),$("#tpl-results").append(d.renderTpl(b,a)),d.rocketcar()}):this.getTpl("results").then(function(b){$("#tpl-results").contents().remove(),$("#tpl-results").append(d.renderTpl(b,a))}),e(a,c),this.showPanel("results"),dashboard.colors(carColors[a.color]),Mini.browser.mobile&&$([$html[0],$body[0]]).animate({scrollTop:0},600)},this.eggs=function(a,b){var c={rocket:{brand:"MINI",code:"RKT",color:"Blazing Red",name:"ALPHA CENTURA",cost:"n/a",alt_1:"SX92",alt_2:"MR92",alt_3:"SS92"}};switch($html.removeClassBeginningWith("egg").addClass("egg-"+a),a){case"rocket":this.render(c.rocket)}},this.rocketcar=function(){var a=$(".rocket-car--car"),b=$(".rocket-car--glow"),c=$(".rocket-car--shadow");TweenMax.to(a,1,{top:"-10px",repeat:-1,yoyo:!0,ease:Linear.easeNone}),TweenMax.to(b,1,{top:"-10px",alpha:1,repeat:-1,yoyo:!0,ease:Linear.easeNone}),TweenMax.to(c,1,{alpha:.3,repeat:-1,yoyo:!0,ease:Linear.easeNone})},this.init=function(b){a.showPanel(b)}}function SocialMedia(){var a=function(a){"direct"===$(a).data("fb-mode")?FB.login(function(a){a.authResponse?FB.api("/me/feed","POST",socialMedia.facebook,function(a){a.error?alert(a.error.error_user_msg):alert("Thanks! Posting completed.")}):alert("We couldn't authorise you. Sorry for the inconvenience.")},{scope:"publish_actions",return_scopes:!0}):FB.ui({method:"share",href:socialMedia.facebook.link},function(a){a&&!a.error_code?alert("Thanks! Posting completed."):alert("We couldn't post to your wall.")})},b=function(a){var b=void 0!==socialMedia.twitter.hashtags?socialMedia.twitter.hashtags:"",c="https://twitter.com/intent/tweet?hashtags="+b+"&text="+socialMedia.twitter.text+"&url="+socialMedia.twitter.url;window.open(c,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")};$body.on("click",".js-sharer li a",function(c){c.preventDefault();var d=$(this).parent();switch($(d).attr("class")){case"facebook":a(d);break;case"twitter":b(d)}})}function Responsive(){var a=matchMedia("( max-width: 767px )"),b=matchMedia("( min-width: 768px ) and ( max-width: 1179px )"),c=matchMedia("( min-width: 1180px )"),d=function(a){this.on=function(){$("body").addClass("mobile");var a=$(".control-title");a.off("click").on("click",function(b){b.preventDefault(),$(this).hasClass("open")?a.removeClass("open"):(a.removeClass("open"),$(this).addClass("open"));var c=$(this).find(".light"),d=$(".switch-bg").css("background-color");$(this).addClass("light"),$(this).hasClass("light")?(c.addClass("switch-light"),$.publish("colour-change",d)):(c.removeClass("switch-light"),c.removeAttr("style"))})},this.off=function(){$("body").removeClass("mobile"),$(".control-title").removeClass("open").off(),$(".control-title").removeClass("light").off(),$(".control-title .light").removeAttr("style").removeClass("switch-light")},a.matches?this.on():this.off()},e=function(a){this.on=function(){$("body").addClass("tablet"),$("#tablet-toggle").off("click").on("click",function(a){if(a.preventDefault(),$("#layout-dash > .column.left").toggleClass("open"),$("#layout-dash").toggleClass("dash-open"),!$("#layout-dash").hasClass("dash-open")&&$("#results").is(":visible")){var b=$("#results").height()+270+"px";$("#layout-dash").css("height",b)}else $("#layout-dash").removeAttr("style");setTimeout(function(){return $("html, body").animate({scrollTop:0},600),!1},200)})},this.off=function(){$("body").removeClass("tablet"),$("#tablet-toggle").off(),$("#layout-dash > .column.left").removeClass("open"),$("#layout-dash, #dash").removeAttr("style")},a.matches?this.on():this.off()},f=function(a){this.on=function(){$("body").addClass("desktop")},this.off=function(){$("body").removeClass("desktop")},a.matches?this.on():this.off()},g=function(){var g=function(){a.matches&&d(a),b.matches&&e(b),c.matches&&f(c)};a.addListener(d),b.addListener(e),c.addListener(f),$(window).on("load orientationchange",g)};g()}function IntroAnimations(){var a=this;this.bg=function(){var a,b=[carColors["Electric Blue"],carColors["Pepper white"],carColors["Lightning Blue"],carColors["Volcanic Orange"],carColors["Jungle Green"],carColors["Blazing Red"]],c=0,d=function(){$.publish("colour-change",b[c]),c<b.length?c++:clearInterval(a)};a=setInterval(d,300)},this.bums=function(){var a=$("#c-bums .roller .list"),b=0;a.each(function(a,c){var d=$(c).height()-160;b+=100,setTimeout(function(){TweenMax.to(c,.4,{y:-d,repeat:1,yoyo:!0,repeatDelay:.5})},b)})},this.mpg=function(){function a(){$({Counter:1}).animate({Counter:13},{duration:500,easing:"swing",step:function(){h=Math.ceil(this.Counter),e.addClass("scale-"+h).removeClassExcept("control mpg scale-"+h)},complete:function(){b()}})}function b(){$({Counter:13}).animate({Counter:1},{duration:500,easing:"swing",step:function(){h=Math.ceil(this.Counter),e.addClass("scale-"+h).removeClassExcept("control mpg scale-"+h)},complete:function(){e.removeClassExcept("control mpg")}})}function c(){$({Counter:25}).animate({Counter:80},{duration:500,easing:"swing",step:function(){i=Math.ceil(this.Counter),g.text(i)},complete:function(){d()}})}function d(){$({Counter:80}).animate({Counter:24},{duration:500,easing:"swing",step:function(){i=Math.ceil(this.Counter),g.text(i)}})}var e=$(".control.mpg"),f=$(".control.mpg .arrow"),g=$(".control.mpg .value");TweenLite.to(f,.5,{rotation:120,onComplete:function(){this.reverse()}}),a();var h=0;c();var i=0},this.options=function(){var a=$(".control.options input").length-1,b=function(){$(".control.options input").each(function(a,b){setTimeout(function(){$(b).addClass("checked")},100*a),setTimeout(function(){$(b).removeClass("checked")},100*a+400)})};b(),setTimeout(function(){b()},100*a+500)},this.price=function(){var a=$(".control.price .handle"),b=$(".control.price .switch-bg"),c="-390px",d="403px";TweenMax.to(a,.5,{y:c,yoyo:!0,repeat:1}),TweenMax.to(b,.5,{height:d,yoyo:!0,repeat:1})},this.lifestyle=function(){var a=($(".control.lifestyle .dial"),$(".items-wrapper")),b=setInterval(function(){a.slick("slickPrev")},0);setTimeout(function(){clearInterval(b)},2e3)},this.speed=function(){var a=$(".control.speed .roller .list"),b=a.height()-160;TweenMax.to(a,.5,{y:-b,repeat:1,yoyo:!0,repeatDelay:.5})},this.luggage=function(){var a=$(".control.luggage .dial");TweenLite.from(a,2,{rotation:360})},this.button=function(){var a=$(".control.start #start"),b=a.find(".button-inner");a.css("pointer-events","none"),TweenMax.from(b,2,{rotation:-1080,onComplete:function(){a.css("pointer-events","auto")}})},this.startAnimations=function(){$(".dash-overlay").removeClass("hide"),a.bums(),a.bg(),a.luggage(),a.button(),a.lifestyle(),setTimeout(function(){a.mpg(),a.options(),a.speed()},500),setTimeout(function(){a.price()},1e3),setTimeout(function(){$(".dash-overlay").addClass("hide")},2500)},this.init=function(){ie.loadFallbacks()||$("#dash").length&&($("body").hasClass("desktop")?a.startAnimations():$("body").hasClass("tablet")&&setTimeout(function(){a.startAnimations()},2e3))}}function trackDialEvents(a){a!=lastTriggeredEvent&&(_gaq.push(["_trackEvent","Dashboard",a]),lastTriggeredEvent=a)}function IE(){var a=["#c-bums #roller1","#c-bums #roller2","#c-bums #roller3","#c-bums #roller4","#c-bums #roller5","#c-speed .control.speed"],b={loadFallbacks:function(){return Mini.browser.isIE("<=9")&&Mini.browser.isIE()},polyfills:function(){$("#dash").addClass("ie-fallbacks"),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")})},flow:function(){document.querySelector("html").className+=" oldie ie"+parseInt(Mini.browser.version),$(".checkbox > input").unwrap(),ui.loadSVGs(),$sys.remove(),$(".control.start .shape").on("click",function(){$("#start").trigger("click")})},rollers:{getSeats:function(){var b=[];return $(_.initial(a)).each(function(a,c){var d=$(c).find(".active").data("value")||$(c).find(".active").text(),e="Empty"===d?0:d;b.push(e)}),b},getSpeed:function(){return $(_.last(a)).find(".active").data("value")},init:function(){$("#reset").remove(),$(a).each(function(a,b){var c=$(b),d=c.find(".list");c.find(".fake-list, .item-extra, .bumper").remove(),d.addClass("list-static").removeClass("list"),c.find(".item:first").addClass("active"),d.on("click",function(){$(".list-static").not(this).removeClass("open"),$(this).toggleClass("open")}),d.find(".item").on("click",function(a){a.preventDefault(),$(this).addClass("active").siblings().removeClass("active")})})}},speed:{init:function(){}},lifestyle:{w:$("#c-lifestyle .window .items-wrapper"),init:function(){this.w.addClass("ie-friendly")},get:function(){var a=$(".items-wrapper .item:first").attr("class").replace("item ","");return a},next:function(){var a=this.w.find(".item"),b=a.filter(":first"),c=a.filter(":last");b.insertAfter(c)},prev:function(){var a=this.w.find(".item"),b=a.filter(":first"),c=a.filter(":last");c.insertBefore(b)}}};return b.loadFallbacks()&&(b.polyfills(),$(document).on("ready",function(){b.flow()})),Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){for(var c=b||0,d=this.length;d>c;c+=1)if(this[c]===a)return c;return-1}),b}var socialMedia={facebook:{link:"https://minicombobulator.co.uk",message:"Find the MINI for you with our clever Combobulator tool.",
name:"THE MINI COMBOBULATOR.",picture:"https://minicombobulator.co.uk/Assets/social/combobulator_social_200x200.png",description:"Want a shiny new MINI, but don't know your Countryman from your Convertible? Let the Combobulator find the right model for you, at the touch of a button. Choose how much you'd like to spend, how turbo-charged you want your engine, and throw in an extra or two."},twitter:{url:"https://minicombobulator.co.uk",text:"Find the MINI for you with our clever Combobulator tool."}},system_paths={net:{assets:"Assets/cars/",results:"results?",spriteFallback:"Assets/sprites",api:"api/car",apiPostcode:"api/postcodelookup",apiDealers:"api/dealerlookup",preload:"api/assets/svg",templates:"Assets/js/tpl"},php:{assets:"assets/cars/",results:"results.php?",spriteFallback:"assets/sprites",api:"json/data.json",apiPostcode:"postcode.php",apiDealers:"dealers.php",preload:"preload.php",templates:"assets/js/tpl"}},path=location.href.indexOf("mini.fs")>=0?system_paths.php:system_paths.net,carColors={"Volcanic Orange":"#f7941d","Electric Blue":"#30b6e8","Lightning Blue":"#1164ac","Jungle Green":"#426046","Blazing Red":"#d71d24","Chili Red":"#d71d24","Pepper White":"#e4dfce","Light White":"#e4dfce","Toy brown":"#47322e","Rocket gold":"gold"},$html=$("html"),$body=$("body"),$sys=$("#system"),w=window,Mini={settings:{debug:!0},thirdParty:{facebookID:815494961880957,analyticsID:"UA-62062073-2"},browser:{name:$.browser.name,version:$.browser.version,mobile:$.browser.mobile||!1,platform:$.browser.platform,isIE:function(version){switch(typeof version){case"string":return"msie"===$.browser.name&&"win"===$.browser.platform&&eval(parseInt($.browser.version)+version);case"number":return"msie"===$.browser.name&&"win"===$.browser.platform&&parseInt($.browser.version)===version;default:return"msie"===$.browser.name&&"win"===$.browser.platform}}}};if(document.querySelector("html").className+=" "+Mini.browser.platform,Mini.browser.isIE()||(document.querySelector("html").className+=" "+Mini.browser.name,$html.removeClass("ie")),"undefined"==typeof Modernizr){var bodyClass=document.querySelector("html").className;document.querySelector("html").className=bodyClass.replace("no-js","js")}$.validator.setDefaults({rules:{name:{required:!0,regexName:!0},surname:{required:!0,regexSurame:!0},address_1:{required:!0},tel_home:{required:!0,regexPhoneUK:!0},dealer:{required:!0},title:{required:!0},postcode_search:{required:!0,regexPostcode:!0},email:{required:!0,email:!0}},messages:{name:{required:"First name is required."},surname:{required:"Last name is required."},address_1:{required:"Address line 1 is required."},postcode:{required:"Postcode is required."},tel_home:{required:"Telephone is required."},dealer:{required:"Please choose a dealer from the list."},title:{required:"Title is required."},postcode_search:{required:"Postcode is required."},email:{required:"E-mail is required.",email:"Please enter a valid e-mail address."}}}),$.validator.addMethod("regexPostcode",function(a,b,c){var d=new RegExp("^(GIR ?0AA|[A-PR-UWYZ]([0-9]{1,2}|([A-HK-Y][0-9]([0-9ABEHMNPRV-Y])?)|[0-9][A-HJKPS-UW]) ?[0-9][ABD-HJLNP-UW-Z]{2})$","i");return this.optional(b)||d.test(a)},"Please enter a valid UK postcode."),$.validator.addMethod("regexPhoneUK",function(a,b){return this.optional(b)||a.match(/^(0|\+44)\d{10}$/)},"Please specify a valid phone number."),$.validator.addMethod("regexName",function(a,b,c){var d=new RegExp("^[a-zA-Z]'?([a-zA-Z]|.| |-)*$");return this.optional(b)||d.test(a)},"Please enter a valid name."),$.validator.addMethod("regexSurame",function(a,b,c){var d=new RegExp("^[a-zA-Z]'?([a-zA-Z]|.| |-)+$");return this.optional(b)||d.test(a)},"Please enter a valid last name."),$.validator.setDefaults({showErrors:function(a,b){b.length>0&&$(b).each(function(b,c){var c=c.element,d=c.tagName.toLowerCase();"select"===d?$(c).parent().addClass("error"):$(c).addClass("error"),$(c).closest(".form-control").find(".error-message").text(a[c.name]).addClass("show")})},submitHandler:function(a){var b=$(a).attr("action"),c=1e3,d=function(){var c={info:$("form").serializeObject(),car:carCode,input:store.get("miniInput")},d=JSON.stringify(c),e=$('input[name="__RequestVerificationToken"]').val();$.ajax({type:"POST",url:b,contentType:"application/json",data:d,headers:{__RequestVerificationToken:e},complete:function(){$(a).toggleClass("busy"),$(".form-control .button").removeAttr("disabled"),$(".form-control .button").removeClass("disabled"),$(".form-sumbitting-overlay").removeClass("active")},success:function(a){$.publish("form-ajax-results",a)},error:function(a,b){for(var c=JSON.parse(a.responseText),d=0;d<c.length;d++){var b=c[d],e=b.Key,f=(b.Message,$("#"+e).addClass("error"));f.attr("aria-required","true")}},beforeSend:function(){Mini.settings.debug}})};$(a).toggleClass("busy"),$(".form-control .button").attr("disabled",!0),$(".form-control .button").addClass("disabled"),$(".form-sumbitting-overlay").addClass("active"),setTimeout(function(){d()},c)},ignore:!1,onkeyup:function(a){$(a).removeClass("error"),$(a).parent().removeClass("error"),$(a).closest(".form-control").find(".form-error").remove(),$(a).closest(".form-control").find(".error-message").removeClass("show")},onfocusout:function(a){$(a).removeClass("error"),$(a).parent().removeClass("error"),$(a).closest(".form-control").find(".form-error").remove(),$(a).closest(".form-control").find(".error-message").removeClass("show")}}),"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){FastClick.attach(document.body)},!1);var lastAccess=store.get("last-access");if(void 0!==lastAccess){expire=new Date(parseInt(lastAccess)+864e5);var currentDate=new Date;expire<currentDate&&store.clear()}else store.clear();store.set("last-access",+new Date);var ie=new IE,ui=new UI,dataLogic=new DataLogic,dashboardLogic=new DashboardLogic,formLogic=new FormLogic,combobulate=new Combobulate,finance=new Finance,query=new dashboardLogic.query,dashboard=new Dashboard,social=new SocialMedia,dials=new Dials,introAnimations=new IntroAnimations;dataLogic.init();var carCode=getQueryParameter("m")||!1,priceChanged=!1,addressObj,dealersObj,responsive,postcodeTimer,form={addresses:"#addresses",address1:"#address_1",address2:"#address_2",address3:"#address_3",town:"#town",postcodeSearch:"#postcode_search",postcode:"#postcode",addressLookup:"#address_lookup",addressChooser:"#address_chooser",dealerChooser:"#dealer_chooser",dealers:"#dealers"},lastTriggeredEvent;(Mini.browser.isIE(">9")||!Mini.browser.isIE())&&(ui.preloadImages(),responsive=new Responsive),$(window).load(function(){dashboard.init(),ui.init("default"),formLogic.init(),finance.init(),combobulate.init()});